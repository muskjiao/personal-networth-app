<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººèµ„äº§è´Ÿå€ºè¡¨ä¸å‡€å€¼ç®¡ç†ç³»ç»Ÿ (é«˜çº§åˆ†æ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* æ·±è‰²èƒŒæ™¯ */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-dark { background: #334155; border: 1px solid #475569; color: white; padding: 8px; border-radius: 6px; width: 100%; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        /* P&L é¢œè‰²å®šä¹‰ (çº¢æ¶¨ ç»¿è·Œ) */
        .up { color: #ef4444; }    /* çº¢è‰²ï¼šæ¶¨ (èµ„äº§/å‡€å€¼) æˆ– è·Œ (è´Ÿå€ºï¼Œåˆ©å¥½) */
        .down { color: #22c55e; }  /* ç»¿è‰²ï¼šè·Œ (èµ„äº§/å‡€å€¼) æˆ– æ¶¨ (è´Ÿå€ºï¼Œåˆ©ç©º) */
        
        /* çªå‡ºæ˜¾ç¤ºçš„å‡€å€¼å’Œè´Ÿå€ºå¡ç‰‡æ ·å¼ */
        .large-metric { padding: 10px 0; border-radius: 8px; margin-top: 5px; }
        .large-metric .value { font-size: 3rem; font-weight: 700; margin-top: 5px; }

        /* æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
        .time-selector { 
            display: flex; 
            border: 1px solid #475569; 
            border-radius: 6px; 
            overflow: hidden;
            background: #334155;
        }
        .time-selector button {
            flex-grow: 1;
            padding: 8px 12px;
            font-size: 0.875rem;
            color: #94a3b8;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .time-selector button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
        }
        
        /* è‡ªå®šä¹‰é…ç½®å¡ç‰‡æ ·å¼ */
        .config-card { background-color: #334155; }
    </style>
</head>
<body>

<div id="app" class="p-6 max-w-7xl mx-auto">
    
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-2xl font-bold text-white">ä¸ªäººèµ„äº§è´Ÿå€ºè¡¨ä¸å‡€å€¼ç®¡ç†ï¼ˆäº‘åŒæ­¥ï¼‰</h1>
            <p class="text-slate-400 text-sm">æ•°æ®å®‰å…¨ï¼šå½“å‰é€šè¿‡ Firebase å®æ—¶åŒæ­¥</p>
        </div>
        <div class="flex gap-2">
            <button @click="exportData" class="btn bg-slate-600 hover:bg-slate-500 text-white text-sm">å¯¼å‡ºå¤‡ä»½</button>
            <button @click="triggerImport" class="btn bg-slate-600 hover:bg-slate-500 text-white text-sm">å¯¼å…¥æœ¬åœ°æ•°æ®</button>
            <input type="file" id="fileInput" @change="importData" style="display:none">
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card border-l-4 border-red-500">
            <div class="text-slate-400 text-md">å½“å‰æ€»èµ„äº§</div>
            <div class="large-metric text-red-400">
                <div class="value">{{ formatCurrency(latestTotalAssets) }}</div>
            </div>
        </div>
        <div class="card border-l-4 border-green-500">
            <div class="text-slate-400 text-md">å½“å‰æ€»è´Ÿå€º</div>
            <div class="large-metric text-green-400">
                <div class="value">{{ formatCurrency(latestTotalLiabilities) }}</div>
            </div>
        </div>
        <div class="card border-l-4 border-orange-500">
            <div class="text-slate-400 text-md">å½“å‰å‡€èµ„äº§ (èµ„äº§ - è´Ÿå€º)</div>
            <div class="large-metric text-orange-400">
                <div class="value">{{ formatCurrency(latestNetWorth) }}</div>
            </div>
        </div>
    </div>
    
    <div class="card mb-6">
        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
            <h3 class="text-lg font-bold">ğŸ“ˆ æ€§èƒ½åˆ†æ</h3>
            <div class="time-selector">
                <button 
                    v-for="period in timePeriods" 
                    :key="period.key"
                    :class="{ 'active': timePeriod === period.key }"
                    @click="timePeriod = period.key"
                >
                    {{ period.label }}
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 rounded-lg bg-slate-700 border-l-4 border-orange-500">
                <div class="text-sm text-slate-400">å‡€èµ„äº§ {{ periodLabels[timePeriod] }}æ¶¨è·Œ</div>
                <div :class="getDiffClass(currentNetWorthStats.amount, true)" class="text-2xl font-bold mt-1">
                    {{ formatCurrency(currentNetWorthStats.amount) }}
                </div>
                <div :class="getDiffClass(currentNetWorthStats.pct, true)" class="text-sm mt-1">
                    {{ currentNetWorthStats.pct }}
                </div>
            </div>
            
            <div class="p-4 rounded-lg bg-slate-700 border-l-4 border-red-500">
                <div class="text-sm text-slate-400">æ€»èµ„äº§ {{ periodLabels[timePeriod] }}æ¶¨è·Œ</div>
                <div :class="getDiffClass(currentTotalAssetStats.amount, true)" class="text-2xl font-bold mt-1">
                    {{ formatCurrency(currentTotalAssetStats.amount) }}
                </div>
                <div :class="getDiffClass(currentTotalAssetStats.pct, true)" class="text-sm mt-1">
                    {{ currentTotalAssetStats.pct }}
                </div>
            </div>

            <div class="p-4 rounded-lg bg-slate-700 border-l-4 border-green-500">
                <div class="text-sm text-slate-400">æ€»è´Ÿå€º {{ periodLabels[timePeriod] }}æ¶¨è·Œ</div>
                <div :class="getDiffClass(currentTotalLiabilitiesStats.amount, false)" class="text-2xl font-bold mt-1">
                    {{ formatCurrency(currentTotalLiabilitiesStats.amount) }}
                </div>
                <div :class="getDiffClass(currentTotalLiabilitiesStats.pct, false)" class="text-sm mt-1">
                    {{ currentTotalLiabilitiesStats.pct }}
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="card h-96" id="assetAnalysisChart"></div>

        <div class="card h-96" id="liabilityAnalysisChart"></div>

        <div class="card h-96" id="netWorthAnalysisChart"></div>
    </div>

    <div class="card overflow-x-auto mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">å†å²å‡€å€¼è®°å½•</h3>
            <button @click="clearAll" class="text-xs text-red-400 underline">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>
        <table class="w-full text-sm text-left text-slate-300">
            <thead class="text-xs uppercase bg-slate-700 text-slate-300">
                <tr>
                    <th class="px-4 py-3">æ—¥æœŸ</th>
                    <th class="px-4 py-3 text-right">æ€»èµ„äº§</th>
                    <th class="px-4 py-3 text-right">æ€»è´Ÿå€º</th>
                    <th class="px-4 py-3 text-right">å‡€å€¼</th>
                    <th class="px-4 py-3 text-right">æ—¥æ¶¨è·Œ</th>
                    <th class="px-4 py-3 text-center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(record, index) in sortedHistory" :key="record.date" class="border-b border-slate-700 hover:bg-slate-800">
                    <td class="px-4 py-3">{{ record.date }}</td>
                    <td class="px-4 py-3 text-right text-red-400">{{ formatCurrency(record.totalAssets) }}</td>
                    <td class="px-4 py-3 text-right text-green-400">{{ formatCurrency(record.totalLiabilities) }}</td>
                    <td class="px-4 py-3 text-right font-bold text-orange-400">{{ formatCurrency(record.netWorth) }}</td>
                    <td class="px-4 py-3 text-right">
                        <span v-if="index < sortedHistory.length - 1" :class="getDiffClass(record.netWorth - sortedHistory[index+1].netWorth, true)">
                            {{ formatCurrency(record.netWorth - sortedHistory[index+1].netWorth) }}
                        </span>
                        <span v-else>-</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button @click="editRecord(record.date)" class="text-blue-400 hover:text-blue-300 mr-2">ç¼–è¾‘</button>
                        <button @click="deleteRecord(record.date)" class="text-red-400 hover:text-red-300">åˆ é™¤</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <h3 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2">ğŸ“… æ•°æ®å½•å…¥ä¸ä¿®æ”¹</h3>
        
        <div class="flex items-center gap-4 mb-4">
            <label class="text-sm">é€‰æ‹©æ—¥æœŸ:</label>
            <input type="date" v-model="selectedDate" class="input-dark w-48">
            <button @click="loadInputData" class="btn bg-slate-600 hover:bg-slate-500 text-white text-sm">åŠ è½½/æ–°å»ºè®°å½•</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="font-semibold text-red-400 mb-3">âœ… èµ„äº§å½•å…¥ (æ€»è®¡: {{ formatCurrency(currentInputAssetsTotal) }})</h4>
                <div v-for="group in config.assetGroups" :key="group.key" class="mb-4 p-3 bg-slate-700 rounded" v-show="group.visible">
                    <h5 class="text-sm font-bold mb-2">{{ group.name }}</h5>
                    <div class="grid grid-cols-3 gap-3">
                        <div v-for="acc in group.accounts" :key="acc.key">
                            <label class="block text-xs text-slate-400 mb-1">{{ acc.name }}</label>
                            <input type="number" step="0.01" v-model.number="inputData.assets[acc.key]" class="input-dark" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-semibold text-green-400 mb-3">âŒ è´Ÿå€ºå½•å…¥ (æ€»å‰©ä½™: {{ formatCurrency(currentInputLiabilitiesTotal) }})</h4>
                <div v-for="group in config.liabilityGroups" :key="group.key" class="mb-4 p-3 bg-slate-700 rounded" v-show="group.visible">
                    <h5 class="text-sm font-bold mb-2">{{ group.name }}</h5>
                    <div class="grid grid-cols-3 gap-3">
                        <div v-for="field in group.fields" :key="field.key">
                            <label class="block text-xs text-slate-400 mb-1">{{ field.name }}</label>
                            <input type="number" step="0.01" v-model.number="inputData.liabilities[group.key][field.key]" class="input-dark" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button @click="submitData" class="btn btn-primary w-full mt-4 h-10">ä¿å­˜/æ›´æ–° {{ selectedDate }} çš„è®°å½•</button>
    </div>
    
    <div class="card config-card mt-6">
        <h3 class="text-lg font-bold mb-4 border-b border-slate-600 pb-2 text-blue-400">âš™ï¸ èµ„äº§/è´Ÿå€ºåˆ†ç±»ç®¡ç† (äº‘ç«¯ä¿å­˜)</h3>
        
        <div class="mb-6">
            <h4 class="text-md font-bold mb-3 text-white">å¤§ç±»æ˜¾ç¤º/éšè—å‹¾é€‰</h4>
            <p class="text-sm text-slate-400 mb-3">å‹¾é€‰çš„é¡¹ç›®å°†æ˜¾ç¤ºåœ¨æ•°æ®å½•å…¥åŒºï¼Œå¹¶å‚ä¸å›¾è¡¨è®¡ç®—ã€‚æœªå‹¾é€‰çš„é¡¹ç›®å°†ä¸æ˜¾ç¤ºåœ¨ UIï¼Œä½†ä¸å½±å“å…¶å†å²æ•°æ®ã€‚</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <div v-for="group in INITIAL_CONFIG.assetGroups" :key="group.key" class="flex items-center">
                    <input type="checkbox" :id="'vis_a_' + group.key" v-model="customVisibility[group.key]" class="mr-2 text-red-500 bg-gray-700 border-gray-600 rounded focus:ring-red-500">
                    <label :for="'vis_a_' + group.key" class="text-sm text-red-400">{{ group.name }}</label>
                </div>
                
                <div v-for="group in INITIAL_CONFIG.liabilityGroups" :key="group.key" class="flex items-center">
                    <input type="checkbox" :id="'vis_l_' + group.key" v-model="customVisibility[group.key]" class="mr-2 text-green-500 bg-gray-700 border-gray-600 rounded focus:ring-green-500">
                    <label :for="'vis_l_' + group.key" class="text-sm text-green-400">{{ group.name }}</label>
                </div>
            </div>
        </div>

        <div class="mb-4 p-3 bg-slate-800 rounded">
             <h4 class="text-md font-bold text-red-400 mb-3">è‡ªå®šä¹‰èµ„äº§è´¦æˆ·åç§° (12 ä¸ª)</h4>
             <p class="text-sm text-slate-400 mb-3">ä¿®æ”¹ä¸‹é¢ 12 ä¸ªè‡ªå®šä¹‰èµ„äº§è´¦æˆ·çš„åç§°ï¼š</p>
            <div v-for="group in INITIAL_CONFIG.assetGroups.filter(g => g.key.includes('other_asset'))" :key="group.key" class="mb-4">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <div v-for="acc in group.accounts" :key="acc.key">
                        <label class="block text-xs text-slate-400 mb-1">{{ acc.key }} åç§°</label>
                        <input type="text" v-model="customAssetNames[acc.key]" class="input-dark text-xs" :placeholder="acc.name">
                    </div>
                </div>
            </div>
        </div>

        <button @click="saveCustomNamesAndVisibility" class="btn bg-blue-600 hover:bg-blue-500 w-full mt-4">ä¿å­˜è‡ªå®šä¹‰é…ç½® (åç§°å’Œå¯è§æ€§) åˆ°äº‘ç«¯</button>
    </div>

</div>

<script>
    // --- æ ¸å¿ƒé…ç½®ï¼šå¯æ‰‹åŠ¨ä¿®æ”¹åç§°å’Œé¡ºåº ---
    
    // ç»Ÿä¸€çš„è´Ÿå€ºå­—æ®µå®šä¹‰
    const commonLiabilityFields = [
        { name: 'æ€»å€Ÿè´·é‡‘é¢', key: 'total_loan' },
        { name: 'æœˆè¿˜æ¬¾é¢', key: 'monthly_payment' },
        { name: 'è¿˜æ¬¾æ—¶é•¿ (æœˆ)', key: 'duration' },
        { name: 'è¿˜æ¬¾å‰©ä½™é‡‘é¢', key: 'remaining_amount' },
        { name: 'æ€»å·²è¿˜é‡‘é¢', key: 'total_paid' },
    ];
    
    // ç”Ÿæˆè‡ªå®šä¹‰èµ„äº§è´¦æˆ·çš„é»˜è®¤é…ç½®
    const createCustomAccounts = (start, count, groupKey) => {
        const accounts = [];
        for (let i = 1; i <= count; i++) {
            const key = `${groupKey}_${i}`;
            accounts.push({ 
                name: `è‡ªå®šä¹‰åˆ†ç±» ${start + i - 1}`, // ç”¨äºé»˜è®¤æ˜¾ç¤º
                key: key 
            });
        }
        return accounts;
    };

    const INITIAL_CONFIG_BASE = {
        assetGroups: [
            { name: 'è¯åˆ¸æŠ•èµ„', key: 'securities', accounts: [
                { name: 'å¹³å®‰', key: 'pingan' }, 
                { name: 'é•¿æ¡¥', key: 'longbridge' }, 
                { name: 'è€è™', key: 'tiger' },
                { name: 'æ¬§æ˜“', key: 'okx' },
                { name: 'å¸å®‰', key: 'binance' },
            ]},
            { name: 'æ´»æœŸèµ„äº§', key: 'liquid', accounts: [
                { name: 'æ”¯ä»˜å®', key: 'alipay' },
                { name: 'å¾®ä¿¡', key: 'wechat' },
                { name: 'é“¶è¡Œå¡', key: 'bank' },
                { name: 'å…¶å®ƒ', key: 'other' },
            ]},
            // æ–°å¢çš„è‡ªå®šä¹‰èµ„äº§ç»„ I (6ä¸ªå­—æ®µ)
            { name: 'å…¶ä»–èµ„äº§ I', key: 'other_asset_1', accounts: createCustomAccounts(1, 6, 'oa1') },
            // æ–°å¢çš„è‡ªå®šä¹‰èµ„äº§ç»„ II (6ä¸ªå­—æ®µ)
            { name: 'å…¶ä»–èµ„äº§ II', key: 'other_asset_2', accounts: createCustomAccounts(7, 6, 'oa2') },
        ],
        liabilityGroups: [
            { name: 'æˆ¿è´·', key: 'mortgage', fields: commonLiabilityFields },
            { name: 'è½¦è´·', key: 'car_loan', fields: commonLiabilityFields },
            { name: 'é—ªç”µè´·', key: 'flash_loan', fields: commonLiabilityFields },
            { name: 'å…¶å®ƒå€Ÿè´·', key: 'other_loan', fields: commonLiabilityFields },
        ]
    };
    
    // æå–æ‰€æœ‰ç»„çš„ key åˆ—è¡¨
    const allGroupKeys = [
        ...INITIAL_CONFIG_BASE.assetGroups.map(g => g.key),
        ...INITIAL_CONFIG_BASE.liabilityGroups.map(g => g.key)
    ];

    // ç”Ÿæˆæ‰€æœ‰è‡ªå®šä¹‰èµ„äº§è´¦æˆ·çš„é»˜è®¤åç§°å¯¹è±¡
    const getDefaultCustomNames = () => {
        const names = {};
        INITIAL_CONFIG_BASE.assetGroups.filter(g => g.key.includes('other_asset')).forEach(group => {
            group.accounts.forEach(acc => {
                names[acc.key] = acc.name;
            });
        });
        return names;
    }
    
    // ç”Ÿæˆæ‰€æœ‰ç»„çš„é»˜è®¤å¯è§æ€§å¯¹è±¡ (é»˜è®¤ä¸º true)
    const getDefaultVisibility = () => {
        const visibility = {};
        allGroupKeys.forEach(key => {
            visibility[key] = true;
        });
        return visibility;
    }

    // --- Firebase é…ç½® (è¯·æ›¿æ¢ä¸ºæ‚¨çš„å¯†é’¥) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDyXZ4qaFZCMXmP1pCA91KJwrHTyT3HnMQ",
        authDomain: "my-networth-tracker.firebaseapp.com",
        databaseURL: "https://my-networth-tracker-default-rtdb.firebaseio.com",
        projectId: "my-networth-tracker",
        storageBucket: "my-networth-tracker.firebasestorage.app",
        messagingSenderId: "499844149842",
        appId: "1:499844149842:web:0761fbb8ae4beceb92e58b",
        measurementId: "G-19RJ3XLQR7"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('historyData');
    const dbCustomConfigRef = firebase.database().ref('customConfig'); // ç»Ÿä¸€çš„é…ç½®ä¿å­˜è·¯å¾„
    
    // --- Vue App ---
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    // ä¿®å¤ï¼šç¡®ä¿ watch åœ¨è¿™é‡Œè¢«æ­£ç¡®è§£æ„å¯¼å…¥ï¼

    createApp({
        setup() {
            // config å¼•ç”¨ INITIAL_CONFIG_BASEï¼Œä½†ä¼šåœ¨åŠ è½½è‡ªå®šä¹‰é…ç½®åè¢«æ›´æ–°
            const config = ref(JSON.parse(JSON.stringify(INITIAL_CONFIG_BASE))); 
            const INITIAL_CONFIG = INITIAL_CONFIG_BASE; // ä»…ç”¨äºæ¨¡æ¿ä¸­çš„å¾ªç¯å’Œé…ç½®UI

            const historyData = ref([]);
            const selectedDate = ref(new Date().toISOString().split('T')[0]);
            
            // è‡ªå®šä¹‰é…ç½®çŠ¶æ€
            const customAssetNames = ref(getDefaultCustomNames()); 
            const customVisibility = ref(getDefaultVisibility());
            
            // --- æ—¶é—´å‘¨æœŸé…ç½® (ä¿æŒä¸å˜) ---
            const timePeriod = ref('month'); 
            const timePeriods = [
                { key: 'day', label: 'æ—¥' }, 
                { key: 'week', label: 'å‘¨' }, 
                { key: 'month', label: 'æœˆ' },
                { key: 'quarter', label: 'å­£' },
                { key: 'year', label: 'å¹´' }
            ];
            const periodLabels = {
                day: 'æ—¥',
                week: 'å‘¨',
                month: 'æœˆ',
                quarter: 'å­£',
                year: 'å¹´',
            };
            const periodDays = {
                day: 1,
                week: 7,
                month: 30,
                quarter: 90,
                year: 365,
            };
            
            const createEmptyInputData = () => {
                const assets = {};
                // ä½¿ç”¨å½“å‰çš„ INITIAL_CONFIG_BASE ç¡®ä¿åŒ…å«æ‰€æœ‰è´¦æˆ·
                INITIAL_CONFIG_BASE.assetGroups.forEach(g => g.accounts.forEach(a => assets[a.key] = 0));
                
                const liabilities = {};
                INITIAL_CONFIG_BASE.liabilityGroups.forEach(g => {
                    liabilities[g.key] = {};
                    g.fields.forEach(f => liabilities[g.key][f.key] = 0);
                });

                return { assets, liabilities };
            };

            const inputData = ref(createEmptyInputData());
            
            // --- é…ç½®æ›´æ–°é€»è¾‘ï¼šå°†è‡ªå®šä¹‰åç§°å’Œå¯è§æ€§åˆå¹¶åˆ° config.value ---
            const updateConfig = () => {
                const newConfig = JSON.parse(JSON.stringify(INITIAL_CONFIG_BASE));
                
                // 1. åˆå¹¶è‡ªå®šä¹‰åç§°
                newConfig.assetGroups.forEach(group => {
                    group.accounts.forEach(account => {
                        if (customAssetNames.value[account.key]) {
                            account.name = customAssetNames.value[account.key];
                        }
                    });
                });
                
                // 2. åˆå¹¶å¯è§æ€§è®¾ç½® (é€‚ç”¨äºæ‰€æœ‰ç»„)
                [...newConfig.assetGroups, ...newConfig.liabilityGroups].forEach(group => {
                    // æ£€æŸ¥ visibility çŠ¶æ€ï¼Œé»˜è®¤ä¸º true
                    group.visible = customVisibility.value[group.key] !== false;
                });
                
                config.value = newConfig;
                renderCharts(); // é…ç½®æ›´æ–°åé‡æ–°æ¸²æŸ“å›¾è¡¨
            };
            
            // --- Firebase Config Load/Save ---
            
            const loadCustomConfig = () => {
                dbCustomConfigRef.once('value', (snapshot) => {
                    const loadedConfig = snapshot.val();
                    
                    // 1. åŠ è½½è‡ªå®šä¹‰åç§°
                    const loadedNames = loadedConfig?.names;
                    customAssetNames.value = loadedNames 
                        ? {...getDefaultCustomNames(), ...loadedNames} 
                        : getDefaultCustomNames();

                    // 2. åŠ è½½å¯è§æ€§
                    const loadedVisibility = loadedConfig?.visibility;
                    customVisibility.value = loadedVisibility
                        ? {...getDefaultVisibility(), ...loadedVisibility}
                        : getDefaultVisibility();
                    
                    updateConfig();
                }, (error) => {
                    console.error("Firebase Config Load Failed: ", error);
                    updateConfig(); // å¤±è´¥ä¹Ÿç”¨é»˜è®¤é…ç½®å¯åŠ¨
                });
            };

            const saveCustomNamesAndVisibility = () => {
                const configToSave = {
                    names: customAssetNames.value,
                    visibility: customVisibility.value
                };
                
                dbCustomConfigRef.set(configToSave)
                    .then(() => {
                        alert("è‡ªå®šä¹‰é…ç½®ï¼ˆåç§°å’Œå¯è§æ€§ï¼‰å·²ä¿å­˜åˆ°äº‘ç«¯å¹¶å·²æ›´æ–°!");
                        updateConfig(); // æ›´æ–° config.value å¹¶é‡ç»˜ UI
                    })
                    .catch(error => {
                        console.error("Firebase Config Save Failed: ", error);
                        alert(`é…ç½®ä¿å­˜å¤±è´¥ï¼š${error.message}`);
                    });
            };

            // --- æ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼šåªè®¡ç®—å¯è§çš„ç»„ ---

            const totalAssets = (record) => {
                if (!record || !record.assets) return 0;
                let total = 0;
                config.value.assetGroups.forEach(g => {
                    // æ£€æŸ¥ç»„æ˜¯å¦å¯è§
                    if (g.visible) {
                        g.accounts.forEach(a => {
                            total += parseFloat(record.assets[a.key] || 0);
                        });
                    }
                });
                return total;
            };

            const totalLiabilities = (record) => {
                if (!record || !record.liabilities) return 0;
                let total = 0;
                config.value.liabilityGroups.forEach(g => {
                    // æ£€æŸ¥ç»„æ˜¯å¦å¯è§
                    if (g.visible) {
                        const remaining = record.liabilities[g.key]?.remaining_amount;
                        total += parseFloat(remaining) || 0;
                    }
                });
                return total;
            };

            const netWorth = (record) => {
                return totalAssets(record) - totalLiabilities(record);
            };

            // ... å…¶ä»–è®¡ç®—å±æ€§å’Œæ–¹æ³•ä¿æŒä¸å˜ ...
            const computedHistory = computed(() => {
                return historyData.value.map(record => ({
                    ...record,
                    totalAssets: totalAssets(record),
                    totalLiabilities: totalLiabilities(record),
                    netWorth: netWorth(record)
                }));
            });

            const sortedHistory = computed(() => {
                return [...computedHistory.value].sort((a, b) => new Date(b.date) - new Date(a.date));
            });
            
            const chartData = computed(() => {
                return [...computedHistory.value].sort((a, b) => new Date(a.date) - new Date(b.date));
            });

            const latestRecord = computed(() => sortedHistory.value[0] || null);
            const latestTotalAssets = computed(() => totalAssets(latestRecord.value));
            const latestTotalLiabilities = computed(() => totalLiabilities(latestRecord.value));
            const latestNetWorth = computed(() => netWorth(latestRecord.value));

            const currentInputAssetsTotal = computed(() => totalAssets(inputData.value));
            const currentInputLiabilitiesTotal = computed(() => totalLiabilities(inputData.value));
            
            // P&L è®¡ç®—é€»è¾‘ (ä¿æŒä¸å˜)
            const getHistoricalValue = (metricFunc, daysAgo) => {
                if (!latestRecord.value || !latestRecord.value.date) return null;
                if (daysAgo === 0) return metricFunc(latestRecord.value);
                const targetDate = new Date(latestRecord.value.date);
                targetDate.setDate(targetDate.getDate() - daysAgo);
                const prevRecord = historyData.value
                    .filter(r => new Date(r.date) <= targetDate)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                return prevRecord ? metricFunc(prevRecord) : null;
            };

            const calculateMetricChange = (metricFunc, daysAgo) => {
                const currentVal = metricFunc(latestRecord.value);
                const previousVal = getHistoricalValue(metricFunc, daysAgo);
                if (previousVal === null || previousVal === undefined) {
                    return { amount: 0, pct: '---' };
                }
                const diff = currentVal - previousVal;
                const pct = previousVal !== 0 ? ((diff / previousVal) * 100).toFixed(2) + '%' : '---';
                return { amount: diff, pct: pct };
            };
            
            const currentTotalAssetStats = computed(() => calculateMetricChange(totalAssets, periodDays[timePeriod.value]));
            const currentTotalLiabilitiesStats = computed(() => calculateMetricChange(totalLiabilities, periodDays[timePeriod.value]));
            const currentNetWorthStats = computed(() => calculateMetricChange(netWorth, periodDays[timePeriod.value]));


            // æ ¼å¼åŒ–å·¥å…· (ä¿æŒä¸å˜)
            const formatCurrency = (val) => {
                if(val === undefined || val === null || isNaN(val)) return '0.00';
                return new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
            };

            const getDiffClass = (val, isPositiveMetric = true) => {
                if (val === 0 || val === '---' || val === null) return 'text-slate-400';
                const numVal = parseFloat(val);
                if (isPositiveMetric) {
                    return numVal > 0 ? 'up' : 'down';   
                } else {
                    return numVal > 0 ? 'down' : 'up'; 
                }
            };
            
            // --- Firebase Listener and CRUD ---

            const startFirebaseListener = () => {
                loadCustomConfig(); // é¦–å…ˆåŠ è½½è‡ªå®šä¹‰é…ç½®
                
                dbRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        historyData.value = Object.keys(data).map(key => data[key]);
                    } else {
                        historyData.value = [];
                    }
                    loadInputData();
                    // renderCharts() ç”± updateConfig() è°ƒç”¨
                }, (error) => {
                    console.error("Firebase Read Failed: ", error);
                });
            };
            
            const submitData = () => {
                const date = selectedDate.value;
                
                if (currentInputAssetsTotal.value === 0 && currentInputLiabilitiesTotal.value === 0) {
                    // è­¦å‘Šï¼šè™½ç„¶å½“å‰æ˜¾ç¤ºçš„èµ„äº§/è´Ÿå€ºæ€»å’Œå¯èƒ½ä¸ºé›¶ï¼Œä½†ç”¨æˆ·å¯èƒ½éšè—äº†æœ‰æ•°æ®çš„é¡¹ç›®ã€‚
                    // è¿™é‡Œçš„æ£€æŸ¥åŸºäºå½“å‰å¯è§çš„è¾“å…¥æ¡†æ€»å’Œï¼Œä»¥é˜²æ­¢è¯¯æ“ä½œã€‚
                    // è­¦å‘Šå¯ä»¥æ›´å®½æ¾ä¸€äº›ï¼Œä½†ä¸ºäº†é¿å…ç©ºè®°å½•ï¼Œæš‚æ—¶ä¿ç•™è¿™ä¸ªæ£€æŸ¥ã€‚
                    alert("è¯·è‡³å°‘å½•å…¥ä¸€ä¸ªå¯è§çš„èµ„äº§æˆ–è´Ÿå€ºé¡¹ç›®çš„é‡‘é¢ã€‚");
                    return;
                }

                // æäº¤çš„æ•°æ®åŒ…å«æ‰€æœ‰èµ„äº§è´¦æˆ·ï¼Œæ— è®ºæ˜¯å¦å¯è§
                const record = JSON.parse(JSON.stringify({ date, ...inputData.value }));

                dbRef.child(date).set(record)
                    .then(() => {
                        alert(`è®°å½• ${date} å·²ä¿å­˜å¹¶åŒæ­¥è‡³äº‘ç«¯!`);
                    })
                    .catch(error => {
                        console.error("Firebase Write Failed: ", error);
                        alert(`è®°å½•ä¿å­˜å¤±è´¥ï¼š${error.message}`);
                    });
            };

            const loadInputData = () => {
                const record = historyData.value.find(r => r.date === selectedDate.value);
                if (record) {
                    const loadedData = JSON.parse(JSON.stringify(record));
                    const emptyData = createEmptyInputData();
                    
                    // æ·±åº¦åˆå¹¶ä»¥ç¡®ä¿æ–°è´¦æˆ·åœ¨ inputData ä¸­å­˜åœ¨ï¼Œæ—§æ•°æ®ä¿ç•™
                    const mergedAssets = {...emptyData.assets, ...loadedData.assets};
                    const mergedLiabilities = {};
                    for (const groupKey in emptyData.liabilities) {
                        mergedLiabilities[groupKey] = {...emptyData.liabilities[groupKey], ...loadedData.liabilities[groupKey]};
                    }
                    
                    inputData.value = { date: loadedData.date, assets: mergedAssets, liabilities: mergedLiabilities };
                } else {
                    inputData.value = createEmptyInputData();
                }
            };
            
            const editRecord = (date) => {
                selectedDate.value = date;
                loadInputData();
            }

            const deleteRecord = (date) => {
                if(confirm(`ç¡®å®šåˆ é™¤ ${date} è¿™æ¡è®°å½•å—ï¼Ÿäº‘ç«¯æ•°æ®ä¹Ÿå°†è¢«åˆ é™¤ï¼`)) {
                    dbRef.child(date).remove()
                        .then(() => {
                            alert(`è®°å½• ${date} å·²ä»äº‘ç«¯åˆ é™¤!`);
                        })
                        .catch(error => {
                            alert(`åˆ é™¤å¤±è´¥ï¼š${error.message}`);
                        });
                }
            };
            
            const clearAll = () => {
                if(confirm('å±é™©æ“ä½œï¼šè¿™å°†æ¸…ç©ºäº‘ç«¯æ‰€æœ‰å†å²æ•°æ®ï¼')) {
                    dbRef.remove()
                        .then(() => {
                            alert('æ‰€æœ‰äº‘ç«¯æ•°æ®å·²æ¸…ç©º!');
                            inputData.value = createEmptyInputData();
                        })
                        .catch(error => {
                            alert(`æ¸…ç©ºå¤±è´¥ï¼š${error.message}`);
                        });
                }
            }
            
            // --- å¯¼å…¥å¯¼å‡º (ä¿æŒä¸å˜) ---
            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(historyData.value));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "balancesheet_backup_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const triggerImport = () => document.getElementById('fileInput').click();

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            const updates = {};
                            imported.forEach(record => {
                                updates[record.date] = record;
                            });
                            dbRef.set(updates)
                                .then(() => {
                                    alert("å¯¼å…¥æˆåŠŸï¼æ•°æ®å·²ä¸Šä¼ åˆ° Firebase å¹¶å·²åŒæ­¥ã€‚");
                                })
                                .catch(err => {
                                    alert(`å¯¼å…¥å¤±è´¥ï¼Œä¸Šä¼ åˆ° Firebase é”™è¯¯: ${err.message}`);
                                });
                        } else {
                            alert("æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®");
                        }
                    } catch (err) {
                        alert("è§£æå¤±è´¥");
                    }
                };
                reader.readAsText(file);
            };

            // --- å›¾è¡¨ç»˜åˆ¶ (Vertical Bar Composition Chart) (æ›´æ–°ï¼šåªåŒ…å«å¯è§çš„ç»„) ---
            let chartAsset, chartLiability, chartNetWorth = null;
            
            const valueFormatter = function(value) {
                if (value === 0 || value === undefined) return '0';
                return value.toLocaleString('zh-CN', { maximumFractionDigits: 0 }); 
            };
            
            const renderCompositionBarChart = (chartId, title, categories, seriesData, color) => {
                let chart = echarts.getInstanceByDom(document.getElementById(chartId));
                if (!chart) chart = echarts.init(document.getElementById(chartId));

                chart.setOption({
                    title: { text: title, textStyle: { color: '#fff' } },
                    tooltip: { trigger: 'axis' },
                    grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
                    
                    xAxis: { 
                        type: 'category', 
                        data: categories, 
                        axisLabel: { color: '#94a3b8', interval: 0, rotate: 30 } 
                    },
                    yAxis: { 
                        type: 'value', 
                        axisLabel: { 
                            color: '#94a3b8',
                            formatter: valueFormatter 
                        }, 
                        splitLine: { lineStyle: { color: '#334155' } } 
                    },
                    series: [{
                        name: 'é‡‘é¢',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: color }
                    }]
                }, true);
                return chart;
            };

            const renderCharts = () => {
                nextTick(() => {
                    if (historyData.value.length === 0) return;
                    
                    const dataForCharts = chartData.value;
                    const dates = dataForCharts.map(d => d.date);
                    const latest = latestRecord.value;
                    
                    // --- 4. èµ„äº§æ„æˆ (åªåŒ…å«å¯è§çš„ç»„) ---
                    const assetCategories = [];
                    const assetValues = [];
                    config.value.assetGroups.forEach(group => {
                        // æ£€æŸ¥ç»„æ˜¯å¦å¯è§
                        if (group.visible) {
                            group.accounts.forEach(account => {
                                assetCategories.push(account.name); 
                                assetValues.push(latest?.assets[account.key] || 0);
                            });
                        }
                    });
                    chartAsset = renderCompositionBarChart(
                        'assetAnalysisChart', 
                        'å½“å‰èµ„äº§è´¦æˆ·æ„æˆ (æ¨ªè½´åˆ†ç±»)', 
                        assetCategories, 
                        assetValues, 
                        '#ef4444'
                    );

                    // --- 5. è´Ÿå€ºæ„æˆ (åªåŒ…å«å¯è§çš„ç»„) ---
                    const liabilityCategories = [];
                    const liabilityValues = [];
                    config.value.liabilityGroups.forEach(group => {
                        // æ£€æŸ¥ç»„æ˜¯å¦å¯è§
                        if (group.visible) {
                            liabilityCategories.push(group.name);
                            liabilityValues.push(latest?.liabilities[group.key]?.remaining_amount || 0);
                        }
                    });
                    chartLiability = renderCompositionBarChart(
                        'liabilityAnalysisChart', 
                        'å½“å‰è´Ÿå€ºé¡¹ç›®æ„æˆ (æ¨ªè½´åˆ†ç±»)', 
                        liabilityCategories, 
                        liabilityValues, 
                        '#22c55e'
                    );

                    // --- 6. å‡€èµ„äº§åˆ†æ (è¶‹åŠ¿çº¿å›¾) ---
                    let chartNetWorth = echarts.getInstanceByDom(document.getElementById('netWorthAnalysisChart'));
                    if (!chartNetWorth) chartNetWorth = echarts.init(document.getElementById('netWorthAnalysisChart'));

                    chartNetWorth.setOption({
                        title: { text: 'å‡€èµ„äº§ã€èµ„äº§ã€è´Ÿå€ºè¶‹åŠ¿', textStyle: { color: '#fff' } },
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['å‡€èµ„äº§', 'æ€»èµ„äº§', 'æ€»è´Ÿå€º'], textStyle: { color: '#94a3b8' }, top: 'bottom' },
                        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                        xAxis: { type: 'category', boundaryGap: false, data: dates, axisLabel: { color: '#94a3b8' } },
                        yAxis: { 
                            type: 'value', 
                            axisLabel: { 
                                color: '#94a3b8',
                                formatter: valueFormatter 
                            }, 
                            splitLine: { lineStyle: { color: '#334155' } } 
                        },
                        series: [
                            { name: 'å‡€èµ„äº§', type: 'line', smooth: true, data: dataForCharts.map(d => d.netWorth), itemStyle: { color: '#fb923c' }, areaStyle: {} }, 
                            { name: 'æ€»èµ„äº§', type: 'line', smooth: true, data: dataForCharts.map(d => d.totalAssets), itemStyle: { color: '#ef4444' } }, 
                            { name: 'æ€»è´Ÿå€º', type: 'line', smooth: true, data: dataForCharts.map(d => d.totalLiabilities), itemStyle: { color: '#22c55e' } }, 
                        ]
                    }, true);

                    window.addEventListener('resize', () => {
                        chartAsset && chartAsset.resize();
                        chartLiability && chartLiability.resize();
                        chartNetWorth && chartNetWorth.resize();
                    });
                });
            };
            
            watch(selectedDate, loadInputData);

            onMounted(() => {
                startFirebaseListener();
            });

            return {
                config,
                INITIAL_CONFIG, // ä¾›æ¨¡æ¿ä¸­é…ç½®åŒºä½¿ç”¨
                selectedDate,
                inputData,
                sortedHistory,
                latestTotalAssets,
                latestTotalLiabilities,
                latestNetWorth,
                currentInputAssetsTotal,
                currentInputLiabilitiesTotal,
                // Custom Config Management
                customAssetNames,
                customVisibility,
                saveCustomNamesAndVisibility,
                // P&L Stats
                currentTotalAssetStats,
                currentTotalLiabilitiesStats,
                currentNetWorthStats,
                timePeriod,
                timePeriods,
                periodLabels,
                // Methods
                submitData,
                loadInputData,
                editRecord,
                deleteRecord,
                formatCurrency,
                getDiffClass,
                exportData,
                triggerImport,
                importData,
                clearAll
            };
        }
    }).mount('#app');
</script>
</body>
</html>
